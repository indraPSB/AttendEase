@using AttendEase.DB.Models
@using AttendEase.Shared.Models

<div class="d-flex flex-wrap gap-2">
    @if (scheduleModels is null)
    {
        <em>Fetching upcoming schedules...</em>
    }
    else if (scheduleModels.Any())
    {
        foreach (UpcomingSchedulesModel model in scheduleModels)
        {
            <Card TextAlignment="Alignment.Center" Style="width: 18rem;">
                <CardHeader>@model.Schedule.Name</CardHeader>
                <CardBody>
                    <CardTitle>Schedule Details:</CardTitle>
                    <CardSubTitle Class="mb-2 text-muted">@model.Schedule.DaysOfWeek</CardSubTitle>
                    <CardSubTitle Class="mb-2 text-muted">@model.Schedule.StartDate - @model.Schedule.EndDate</CardSubTitle>
                    <CardSubTitle Class="mb-2 text-muted">@model.Schedule.StartTime - @model.Schedule.EndTime </CardSubTitle>
                    <CardText>
                        @if (model.Schedule is { Latitude: decimal, Longitude: decimal, LocationTolerance: float })
                        {
                            <span><Icon Name="IconName.PinMapFill" Class="me-2" />@model.Schedule.Latitude,@model.Schedule.Longitude</span>
                            if (model.IsLocationServiceAvailable)
                            {
                                if (model.IsWithinPremise.HasValue)
                                {
                                    if (model.IsWithinPremise.Value)
                                    {
                                        <Badge Color="BadgeColor.Success" IndicatorType="BadgeIndicatorType.RoundedPill">You are within the premises</Badge>
                                    }
                                    else
                                    {
                                        <Badge Color="BadgeColor.Danger" IndicatorType="BadgeIndicatorType.RoundedPill">You are not within the premises</Badge>
                                    }
                                }
                            }
                            else
                            {
                                <Badge Color="BadgeColor.Warning" IndicatorType="BadgeIndicatorType.RoundedPill">Location service not available</Badge>
                            }
                        }
                        else
                        {
                            <span>-</span>
                            <Badge Color="BadgeColor.Secondary" IndicatorType="BadgeIndicatorType.RoundedPill">Schedule doesn't require location tracking</Badge>
                        }
                    </CardText>
                    <CardTitle>Attendance Marking Details:</CardTitle>
                    <CardText>@($"{model.attendanceStart:t}") - @($"{model.attendanceEnd:t}")</CardText>
                    <CardText>
                        @if (model.CanMarkAttendance())
                        {
                            <Button Color="ButtonColor.Primary">Mark Attendance</Button>
                        }
                        else
                        {
                            <Button Color="ButtonColor.Secondary" Disabled="true">Not Attendance Window</Button>
                        }
                    </CardText>
                </CardBody>
            </Card>
        }
    }
    else
    {
        <em>No upcoming schedules.</em>
    }
</div>

@code {
    [Inject] public IAuthService AuthService { get; set; } = default!;
    [Inject] public IAttendanceService AttendanceService { get; set; } = default!;
    [Inject] public ILocationService LocationService { get; set; } = default!;
    [Inject] public IScheduleService ScheduleService { get; set; } = default!;

    private IEnumerable<UpcomingSchedulesModel>? scheduleModels = default!;
    private PeriodicTimer timer = new PeriodicTimer(TimeSpan.FromSeconds(5));

    override protected async Task OnInitializedAsync()
    {
        do
        {
            await UpdateLocationAsync();
        }
        while (await timer.WaitForNextTickAsync());
    }

    private async Task UpdateLocationAsync()
    {
        User? user = await AuthService.GetUser();

        if (user is not null)
        {
            bool isLocationServiceAvailable = (await LocationService.GetCurrentLocation()) != new Location(0, 0);
            List<UpcomingSchedulesModel> scheduleModels = [];

            foreach (Schedule schedule in (await ScheduleService.GetSchedules(user.Id)) ?? Enumerable.Empty<Schedule>())
            {
                if (schedule.EndDate.HasValue && schedule.EndDate.Value < DateOnly.FromDateTime(DateTimeOffset.Now.DateTime))
                {
                    continue;
                }

                DateTimeOffset today = new DateTimeOffset(DateOnly.FromDateTime(DateTimeOffset.Now.Date), schedule.StartTime ?? new TimeOnly(), TimeSpan.Zero);
                DateTimeOffset start = today.AddMinutes(-schedule.AttendanceStartBefore);
                DateTimeOffset end = today.AddMinutes(schedule.AbsentAfter);

                Attendance attendance = (await AttendanceService.GetAttendance(new()
                {
                    UserId = user.Id,
                    ScheduleId = schedule.Id,
                    TimestampStart = start,
                    TimestampEnd = end
                }))!;

                bool? isWithinPremises = null;

                if (isLocationServiceAvailable && schedule is { Latitude: decimal latitude, Longitude: decimal longitude, LocationTolerance: float tolerance })
                {
                    isWithinPremises = await LocationService.IsWithinPremises(new Location((double)latitude, (double)longitude), (double)tolerance);
                }

                UpcomingSchedulesModel upcomingSchedulesModel = new()
                {
                    Schedule = schedule,
                    Attendance = attendance,
                    IsLocationServiceAvailable = isLocationServiceAvailable,
                    IsWithinPremise = isWithinPremises,
                    attendanceStart = start,
                    attendanceEnd = end
                };

                scheduleModels.Add(upcomingSchedulesModel);
            }

            this.scheduleModels = (IEnumerable<UpcomingSchedulesModel>)scheduleModels;
        }

        StateHasChanged();
    }

    class UpcomingSchedulesModel
    {
        public Schedule Schedule { get; set; } = default!;
        public Attendance Attendance { get; set; } = default!;
        public bool IsLocationServiceAvailable { get; set; } = false;
        public bool? IsWithinPremise { get; set; } = null;
        public DateTimeOffset attendanceStart { get; set; }
        public DateTimeOffset attendanceEnd { get; set; }

        public bool CanMarkAttendance()
        {
            return true;
        }
    }
}
